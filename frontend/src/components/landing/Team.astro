---
// Team component

// Team data with inline typing
const teamData = [
  {
    name: "Antonio Castellano",
    image: "https://autosalonvolketswil.ch/wp-content/uploads/2025/05/Antonio-scaled.jpg",
    position: "Automobilverkäufer",
    email: "antonio@autosalonvolketswil.ch",
    phone: "+41 44 123 45 67"
  },
  {
    name: "Kenan Midzan",
    image: "https://autosalonvolketswil.ch/wp-content/uploads/2025/05/Kenan-scaled.jpg",
    position: "Automobilverkäufer",
    email: "kenan@autosalonvolketswil.ch",
    phone: "+41 44 123 45 68"
  },
  {
    name: "Selina Doll",
    image: "https://autosalonvolketswil.ch/wp-content/uploads/2025/05/Selina-scaled.jpg",
    position: "Assistenz der Geschäftsleitung",
    email: "selina@autosalonvolketswil.ch",
    phone: "+41 44 123 45 69"
  },
  {
    name: "Francesco Sigillo",
    image: "https://autosalonvolketswil.ch/wp-content/uploads/2025/05/Francesco-scaled.jpg",
    position: "Marketing",
    email: "francesco@autosalonvolketswil.ch",
    phone: "+41 44 123 45 70"
  },
  {
    name: "Mikael Da Costa Botelho",
    image: "https://autosalonvolketswil.ch/wp-content/uploads/2025/05/Miki-scaled.jpg",
    position: "Aufbereiter",
    email: "",
    phone: ""
  },
  {
    name: "Rodion Wagner",
    image: "https://autosalonvolketswil.ch/wp-content/uploads/2025/05/Rodion-scaled.jpg",
    position: "Aufbereiter",
    email: "",
    phone: ""
  },
  {
    name: "Fernando Pinheiro",
    image: "https://autosalonvolketswil.ch/wp-content/uploads/2025/05/Fernando-scaled.jpg",
    position: "Aufbereiter",
    email: "",
    phone: ""
  },
  {
    name: "Levin Paprotka",
    image: "https://autosalonvolketswil.ch/wp-content/uploads/2025/05/Levin-scaled.jpg",
    position: "Mechaniker",
    email: "",
    phone: ""
  },
  {
    name: "Nadim Ghani",
    image: "https://autosalonvolketswil.ch/wp-content/uploads/2025/05/DSC01352-scaled.jpg",
    position: "Mitglied GL & Verkaufsleiter",
    email: "nadim@autosalonvolketswil.ch",
    phone: "+41 44 123 45 75"
  },
  {
    name: "Mario Betschart",
    image: "https://autosalonvolketswil.ch/wp-content/uploads/2025/05/DSC01454-2-scaled.jpg",
    position: "Mitglied GL & Einkäufer",
    email: "mario@autosalonvolketswil.ch",
    phone: "+41 44 123 45 76"
  },
  {
    name: "Sali Saliu",
    image: "https://autosalonvolketswil.ch/wp-content/uploads/2024/01/DSC6181-scaled.jpg",
    position: "Inhaber & Geschäftsführer",
    email: "sali@autosalonvolketswil.ch",
    phone: "+41 44 123 45 77"
  }
] as const;
---

<!-- Team Section -->
<section id="team" class="team-gallery-container" style="height: 300vh;">
  <!-- Sticky container that stays in view -->
  <div class="sticky top-0 w-full h-screen bg-primary relative overflow-hidden">
    
    <!-- Progress bar -->
    <div class="team-progress-track absolute top-20 left-0 w-full h-1 bg-black/20 z-30">
      <div class="team-progress-line h-full bg-secondary transition-all duration-300 ease-out" style="width: 0%"></div>
    </div>
    
    <!-- Title overlay -->
    <div class="team-title absolute inset-0 flex items-center justify-center z-20 pointer-events-none">
      <div class="text-center">
        <h2 class="text-secondary text-6xl md:text-7xl lg:text-8xl font-bold mb-4">
          Unser Team
        </h2>
        <div class="w-24 h-1 bg-secondary mx-auto"></div>
      </div>
    </div>

    <!-- Team Grid Container - Full Screen -->
    <div class="team-grid-wrapper absolute inset-0 w-full top-20" style="height: 85vh;">
      <div class="team-grid h-full w-full">
        {teamData.map((member, index) => (
          <div 
            class="team-member relative overflow-hidden group cursor-pointer"
            data-team-index={index}>
            <!-- Background Image -->
            <img 
              src={member.image}
              alt={member.name}
              class="absolute inset-0 w-full h-full object-cover group-hover:scale-110 transition-transform duration-700"
              loading="lazy"
            />
            
            <!-- Dark Overlay -->
            <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/20 to-transparent group-hover:from-black/90 transition-all duration-300"></div>
            
            <!-- Text Content -->
            <div class="absolute bottom-0 left-0 right-0 p-4 text-white z-10">
              <h3 class="text-lg font-bold mb-1 group-hover:text-secondary transition-colors duration-300">
                {member.name}
              </h3>
              <p class="text-sm opacity-90 group-hover:opacity-100 transition-opacity duration-300">
                {member.position}
              </p>
            </div>
          </div>
        ))}
      </div>
    </div>
  </div>
</section>

<!-- Team Member Modal -->
<div 
  id="teamModal"
  class="fixed inset-0 bg-black/70 backdrop-blur-sm z-60 opacity-0 invisible transition-all duration-300 ease-out">
  
  <!-- Modal Content -->
  <div class="flex items-center justify-center min-h-screen p-4">
    <div 
      id="modalContent"
      class="bg-primary border-2 border-secondary/30 max-w-md w-full transform scale-90 transition-all duration-300 ease-out">
      
      <!-- Modal Header -->
      <div class="relative">
        <!-- Member Image -->
        <div class="h-64 overflow-hidden">
          <img 
            id="modalImage"
            src=""
            alt=""
            class="w-full h-full object-cover"
          />
        </div>
        
        <!-- Close Button -->
        <button 
          id="modalClose"
          class="absolute top-4 right-4 w-10 h-10 bg-black/50 backdrop-blur-sm border-2 border-secondary/30 hover:border-secondary flex items-center justify-center transition-colors"
          aria-label="Modal schließen">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-secondary">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      
      <!-- Modal Body -->
      <div class="p-6">
        <!-- Name and Position -->
        <div class="mb-6">
          <h3 id="modalName" class="text-2xl font-bold text-secondary mb-2"></h3>
          <p id="modalPosition" class="text-secondary/80"></p>
        </div>
        
        <!-- Contact Information -->
        <div class="space-y-4">
          <!-- Phone -->
          <div class="flex items-center space-x-3">
            <div class="w-10 h-10 bg-secondary/10 border border-secondary/30 flex items-center justify-center">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-secondary">
                <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
              </svg>
            </div>
            <div>
              <p class="text-secondary/60 text-sm">Telefon</p>
              <a id="modalPhone" href="" class="text-secondary hover:text-secondary/80 transition-colors font-medium"></a>
            </div>
          </div>
          
          <!-- Email Button -->
          <a 
            id="modalEmail"
            href=""
            class="w-full bg-secondary text-primary py-3 px-4 flex items-center justify-center space-x-3 hover:bg-secondary/90 transition-colors font-bold">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
              <polyline points="22,6 12,13 2,6"></polyline>
            </svg>
            <span>E-Mail senden</span>
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  class TeamGallery {
    private container: HTMLElement | null;
    private teamTitle: HTMLElement | null;
    private teamMembers: NodeListOf<Element>;
    private progressLine: HTMLElement | null;
    private totalMembers: number;
    private isInGallery: boolean;
    private modal: HTMLElement | null;
    private modalContent: HTMLElement | null;
    private teamData: readonly any[];

    constructor() {
      this.container = document.querySelector('.team-gallery-container');
      this.teamTitle = document.querySelector('.team-title');
      this.teamMembers = document.querySelectorAll('.team-member');
      this.progressLine = document.querySelector('.team-progress-line');
      this.modal = document.getElementById('teamModal');
      this.modalContent = document.getElementById('modalContent');
      
      this.totalMembers = 11;
      this.isInGallery = false;
      
      // Get team data from window object (will be set by Astro)
      this.teamData = (window as any).teamData || [];
      
      this.init();
    }
    
    init(): void {
      this.setupScrollListener();
      this.resetToInitialState();
      this.setupModalHandlers();
      this.setupTeamMemberClicks();
    }
    
    setupScrollListener(): void {
      let ticking = false;
      
      window.addEventListener('scroll', () => {
        if (!ticking) {
          requestAnimationFrame(() => {
            this.handleScroll();
            ticking = false;
          });
          ticking = true;
        }
      });
    }
    
    handleScroll(): void {
      if (!this.container) return;
      
      const containerRect = this.container.getBoundingClientRect();
      const containerHeight = this.container.offsetHeight;
      const viewportHeight = window.innerHeight;
      
      // Check if we're in the team section
      if (containerRect.top <= 0 && containerRect.bottom >= viewportHeight) {
        if (!this.isInGallery) {
          this.initializeTitleState();
        }
        this.isInGallery = true;
        
        // Calculate scroll progress (0 to 1)
        const scrollProgress = Math.abs(containerRect.top) / (containerHeight - viewportHeight);
        const clampedProgress = Math.max(0, Math.min(1, scrollProgress));
        
        // Create phases: 
        // 0 - 0.5: Team members fly in from right
        // 0.5 - 1.0: Hold phase (everything stays visible, just scrolls up)
        
        let animationProgress = clampedProgress;
        let isHoldPhase = false;
        
        if (clampedProgress <= 0.5) {
          animationProgress = clampedProgress / 0.5;
          isHoldPhase = false;
        } else {
          animationProgress = 1;
          isHoldPhase = true;
        }
        
        // Update animations
        this.updateTitlePosition(animationProgress, isHoldPhase);
        this.updateTeamMembers(animationProgress, isHoldPhase);
        this.updateProgress(clampedProgress);
        
      } else {
        // Only reset if we haven't been in the gallery yet
        // Once animated in, cards stay visible permanently
        if (!this.isInGallery) {
          this.resetToInitialState();
        } else {
          // Keep cards visible, just hide title and progress
          if (this.teamTitle) {
            this.teamTitle.style.opacity = '0';
          }
          if (this.progressLine) {
            this.progressLine.style.width = '100%';
          }
        }
      }
    }
    
    initializeTitleState(): void {
      if (this.teamTitle) {
        this.teamTitle.style.opacity = '1';
      }
    }
    
    resetToInitialState(): void {
      // Reset title
      if (this.teamTitle) {
        this.teamTitle.style.opacity = '1';
      }
      
      // Reset all team members
      this.teamMembers.forEach((member: Element) => {
        const htmlMember = member as HTMLElement;
        htmlMember.style.transform = 'translateX(100%)';
        htmlMember.style.opacity = '0';
      });
      
      // Reset progress line
      if (this.progressLine) {
        this.progressLine.style.width = '0%';
      }
    }
    
    updateTitlePosition(progress: number, isHoldPhase: boolean): void {
      if (!this.teamTitle) return;
      
      // Title fades much faster - starts fading immediately
      let opacity = 1;
      
      if (progress > 0.1) {
        const fadeProgress = (progress - 0.1) / 0.3; // Fade over 30% instead of 70%
        opacity = Math.max(0, 1 - fadeProgress);
      }
      
      // During hold phase, title is completely gone
      if (isHoldPhase) {
        opacity = 0;
      }
      
      this.teamTitle.style.opacity = opacity.toString();
    }
    
    updateTeamMembers(animationProgress: number, isHoldPhase: boolean): void {
      // Each member appears sequentially from right
      const memberInterval = 1 / this.totalMembers;
      
      this.teamMembers.forEach((member: Element, index: number) => {
        const htmlMember = member as HTMLElement;
        const memberStart = index * memberInterval;
        
        if (animationProgress >= memberStart) {
          // Calculate this member's progress (0 to 1)
          let memberProgress = Math.min(1, (animationProgress - memberStart) / (memberInterval * 1.5));
          
          // During hold phase, keep at full visibility - NO FADE OUT
          if (isHoldPhase) {
            memberProgress = 1;
          }
          
          // Smooth easing for fly-in effect
          const easedProgress = this.easeOutCubic(memberProgress);
          
          // Slide in from right
          const translateX = (1 - easedProgress) * 100;
          const opacity = easedProgress;
          
          htmlMember.style.transform = `translateX(${translateX}%)`;
          htmlMember.style.opacity = opacity.toString();
          
        } else {
          // Hide members that haven't started yet
          htmlMember.style.transform = 'translateX(100%)';
          htmlMember.style.opacity = '0';
        }
      });
    }
    
    updateProgress(progress: number): void {
      if (this.progressLine) {
        this.progressLine.style.width = `${progress * 100}%`;
      }
    }
    
    // Modal functionality
    setupModalHandlers(): void {
      const modalClose = document.getElementById('modalClose');
      
      // Close modal handlers
      modalClose?.addEventListener('click', () => this.closeModal());
      this.modal?.addEventListener('click', (e) => {
        if (e.target === this.modal) {
          this.closeModal();
        }
      });
      
      // Close modal on escape key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && this.modal && !this.modal.classList.contains('invisible')) {
          this.closeModal();
        }
      });
    }
    
    setupTeamMemberClicks(): void {
      this.teamMembers.forEach((member, index) => {
        member.addEventListener('click', () => {
          this.openModal(index);
        });
      });
    }
    
    openModal(memberIndex: number): void {
      if (!this.modal || !this.teamData[memberIndex]) return;
      
      const member = this.teamData[memberIndex];
      
      // Populate modal content
      const modalImage = document.getElementById('modalImage') as HTMLImageElement;
      const modalName = document.getElementById('modalName');
      const modalPosition = document.getElementById('modalPosition');
      const modalPhone = document.getElementById('modalPhone') as HTMLAnchorElement;
      const modalEmail = document.getElementById('modalEmail') as HTMLAnchorElement;
      
      // Get container elements for conditional display
      const phoneContainer = modalPhone?.parentElement?.parentElement;
      const emailContainer = modalEmail;
      
      if (modalImage) {
        modalImage.src = member.image;
        modalImage.alt = member.name;
      }
      
      if (modalName) modalName.textContent = member.name;
      if (modalPosition) modalPosition.textContent = member.position;
      
      // Show/hide phone section based on data availability
      if (member.phone && modalPhone && phoneContainer) {
        modalPhone.textContent = member.phone;
        modalPhone.href = `tel:${member.phone}`;
        phoneContainer.style.display = 'flex';
      } else if (phoneContainer) {
        phoneContainer.style.display = 'none';
      }
      
      // Show/hide email section based on data availability
      if (member.email && modalEmail) {
        modalEmail.href = `mailto:${member.email}?subject=Kontaktanfrage von der Website&body=Hallo ${member.name},%0D%0A%0D%0AIch würde gerne Kontakt mit Ihnen aufnehmen.%0D%0A%0D%0AMit freundlichen Grüßen`;
        modalEmail.style.display = 'flex';
      } else if (modalEmail) {
        modalEmail.style.display = 'none';
      }
      
      // Show modal
      this.modal.classList.remove('opacity-0', 'invisible');
      if (this.modalContent) {
        setTimeout(() => {
          this.modalContent?.classList.remove('scale-90');
          this.modalContent?.classList.add('scale-100');
        }, 50);
      }
      
      // Prevent body scroll
      document.body.classList.add('overflow-hidden');
    }
    
    closeModal(): void {
      if (!this.modal) return;
      
      // Hide modal
      if (this.modalContent) {
        this.modalContent.classList.remove('scale-100');
        this.modalContent.classList.add('scale-90');
      }
      
      setTimeout(() => {
        this.modal?.classList.add('opacity-0', 'invisible');
      }, 200);
      
      // Restore body scroll
      document.body.classList.remove('overflow-hidden');
    }
    
    // Easing function for smooth animations
    easeOutCubic(t: number): number {
      return 1 - Math.pow(1 - t, 3);
    }
  }
  
  // Initialize team gallery when DOM is loaded
  document.addEventListener('DOMContentLoaded', () => {
    // Make team data available to JavaScript
    (window as any).teamData = [
      {
        name: "Antonio Castellano",
        image: "https://autosalonvolketswil.ch/wp-content/uploads/2025/05/Antonio-scaled.jpg",
        position: "Automobilverkäufer",
        email: "antonio@autosalonvolketswil.ch",
        phone: "+41 44 123 45 67"
      },
      {
        name: "Kenan Midzan",
        image: "https://autosalonvolketswil.ch/wp-content/uploads/2025/05/Kenan-scaled.jpg",
        position: "Automobilverkäufer",
        email: "kenan@autosalonvolketswil.ch",
        phone: "+41 44 123 45 68"
      },
      {
        name: "Selina Doll",
        image: "https://autosalonvolketswil.ch/wp-content/uploads/2025/05/Selina-scaled.jpg",
        position: "Assistenz der Geschäftsleitung",
        email: "selina@autosalonvolketswil.ch",
        phone: "+41 44 123 45 69"
      },
      {
        name: "Francesco Sigillo",
        image: "https://autosalonvolketswil.ch/wp-content/uploads/2025/05/Francesco-scaled.jpg",
        position: "Marketing",
        email: "francesco@autosalonvolketswil.ch",
        phone: "+41 44 123 45 70"
      },
      {
        name: "Mikael Da Costa Botelho",
        image: "https://autosalonvolketswil.ch/wp-content/uploads/2025/05/Miki-scaled.jpg",
        position: "Aufbereiter",
        email: "",
        phone: ""
      },
      {
        name: "Rodion Wagner",
        image: "https://autosalonvolketswil.ch/wp-content/uploads/2025/05/Rodion-scaled.jpg",
        position: "Aufbereiter",
        email: "",
        phone: ""
      },
      {
        name: "Fernando Pinheiro",
        image: "https://autosalonvolketswil.ch/wp-content/uploads/2025/05/Fernando-scaled.jpg",
        position: "Aufbereiter",
        email: "",
        phone: ""
      },
      {
        name: "Levin Paprotka",
        image: "https://autosalonvolketswil.ch/wp-content/uploads/2025/05/Levin-scaled.jpg",
        position: "Mechaniker",
        email: "",
        phone: ""
      },
      {
        name: "Nadim Ghani",
        image: "https://autosalonvolketswil.ch/wp-content/uploads/2025/05/DSC01352-scaled.jpg",
        position: "Mitglied GL & Verkaufsleiter",
        email: "nadim@autosalonvolketswil.ch",
        phone: "+41 44 123 45 75"
      },
      {
        name: "Mario Betschart",
        image: "https://autosalonvolketswil.ch/wp-content/uploads/2025/05/DSC01454-2-scaled.jpg",
        position: "Mitglied GL & Einkäufer",
        email: "mario@autosalonvolketswil.ch",
        phone: "+41 44 123 45 76"
      },
      {
        name: "Sali Saliu",
        image: "https://autosalonvolketswil.ch/wp-content/uploads/2024/01/DSC6181-scaled.jpg",
        position: "Inhaber & Geschäftsführer",
        email: "sali@autosalonvolketswil.ch",
        phone: "+41 44 123 45 77"
      }
    ];
    
    new TeamGallery();
  });
</script>

<style>
  /* Dynamic Grid System */
  .team-grid {
    display: grid;
    gap: 0; /* No gaps between images */
  }
  
  /* Grid breakpoints based on screen width */
  /* Mobile Portrait: 3 columns */
  @media (max-width: 639px) {
    .team-grid {
      grid-template-columns: repeat(3, 1fr);
      grid-template-rows: repeat(4, 1fr);
    }
  }
  
  /* Mobile Landscape: 3 columns */
  @media (min-width: 640px) and (max-width: 767px) {
    .team-grid {
      grid-template-columns: repeat(3, 1fr);
      grid-template-rows: repeat(4, 1fr);
    }
  }
  
  /* Tablet: 3 columns */
  @media (min-width: 768px) and (max-width: 1023px) {
    .team-grid {
      grid-template-columns: repeat(3, 1fr);
      grid-template-rows: repeat(4, 1fr);
    }
  }
  
  /* Desktop: 4 columns */
  @media (min-width: 1024px) and (max-width: 1399px) {
    .team-grid {
      grid-template-columns: repeat(4, 1fr);
      grid-template-rows: repeat(3, 1fr);
    }
  }
  
  /* Large Desktop: 5 columns */
  @media (min-width: 1400px) and (max-width: 1799px) {
    .team-grid {
      grid-template-columns: repeat(5, 1fr);
      grid-template-rows: repeat(3, 1fr);
    }
  }
  
  /* Extra Large Desktop: 6 columns */
  @media (min-width: 1800px) {
    .team-grid {
      grid-template-columns: repeat(6, 1fr);
      grid-template-rows: repeat(2, 1fr);
    }
  }
  
  /* Team members - INITIALLY HIDDEN */
  .team-member {
    opacity: 0;
    transform: translateX(100%);
    transition: opacity 0.8s ease, transform 0.8s ease;
    will-change: transform, opacity;
  }
  
  /* Title content */
  .team-title {
    transition: opacity 0.6s ease;
    opacity: 1;
  }
  
  /* Performance optimizations */
  .team-title,
  .team-member {
    transform: translateZ(0);
    backface-visibility: hidden;
  }
  
  /* Progress bar */
  .team-progress-track {
    backdrop-filter: blur(8px);
  }
  
  /* Ensure images maintain aspect ratio and fill container */
  .team-member img {
    object-fit: cover;
    width: 100%;
    height: 100%;
  }
  
  /* Text content positioning */
  .team-member h3,
  .team-member p {
    text-shadow: 0 2px 4px rgba(0,0,0,0.8);
  }
  
  /* Handle 11 items in different grid layouts */
  .team-grid > .team-member:nth-child(11) {
    /* Last item styling if needed */
  }
  
  /* Mobile specific adjustments */
  @media (max-width: 767px) {
    .team-title h2 {
      font-size: 3rem;
    }
    
    .team-member {
      min-height: calc(85vh / 4);
    }
  }
  
  /* Modal styles */
  #teamModal.show {
    opacity: 1 !important;
    visibility: visible !important;
  }
  
  #modalContent.show {
    transform: scale(1) !important;
  }
  
  /* Modal responsive */
  @media (max-width: 640px) {
    #modalContent {
      margin: 1rem;
      max-width: calc(100vw - 2rem);
    }
  }
</style> 